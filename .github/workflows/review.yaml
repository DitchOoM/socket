name: "Build and Test"
on:
  pull_request:
    paths-ignore:
      - '*.md'
    types:
      - synchronize
      - opened

jobs:
  linux-x64:
    name: "Linux x64 / JVM / JS / Android"
    runs-on: ubuntu-24.04
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'
          cache: gradle
      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
      - name: Setup Android SDK
        uses: android-actions/setup-android@v2
      - name: Cache Konan
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: konan-linux-${{ hashFiles('gradle/libs.versions.toml') }}
          restore-keys: konan-linux-
      - name: Cache OpenSSL
        uses: actions/cache@v4
        with:
          path: libs/openssl/linux-x64
          key: openssl-linux-x64-v5-${{ hashFiles('gradle/libs.versions.toml') }}
      - name: Cache OpenSSL ARM64
        uses: actions/cache@v4
        with:
          path: libs/openssl/linux-arm64
          key: openssl-linux-arm64-v5-${{ hashFiles('gradle/libs.versions.toml') }}
      - name: Cache liburing x64
        uses: actions/cache@v4
        with:
          path: libs/liburing/linux-x64
          key: liburing-linux-x64-v1-${{ hashFiles('gradle/libs.versions.toml') }}
      - name: Cache liburing ARM64
        uses: actions/cache@v4
        with:
          path: libs/liburing/linux-arm64
          key: liburing-linux-arm64-v1-${{ hashFiles('gradle/libs.versions.toml') }}
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential perl qemu-user-static
          # ARM64 cross-compilation toolchain
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          # ARM64 runtime libraries for QEMU - download and extract directly
          mkdir -p /tmp/arm64-libs
          cd /tmp/arm64-libs
          curl -LO http://ports.ubuntu.com/pool/main/libx/libxcrypt/libcrypt1_4.4.36-4build1_arm64.deb
          ar x libcrypt1_*.deb
          tar xf data.tar.zst
          sudo cp -r usr/lib/aarch64-linux-gnu/* /usr/aarch64-linux-gnu/lib/
      - name: Run checks and tests
        run: ./gradlew jvmTest jsTest linuxX64Test testDebugUnitTest ktlintCheck
      - name: Build ARM64 test binary
        run: ./gradlew linkDebugTestLinuxArm64
      - name: Run ARM64 tests via QEMU (subset for validation)
        # LinuxTlsTests validates io_uring, OpenSSL, and static linking - all critical ARM64 dependencies
        run: qemu-aarch64-static -L /usr/aarch64-linux-gnu ./build/bin/linuxArm64/debugTest/test.kexe --ktest_filter=com.ditchoom.socket.LinuxTlsTests
      - name: Validate publish artifacts build
        # Build all publishable artifacts to MavenLocal with fixed version for artifact collection
        run: ./gradlew publishToMavenLocal -Pversion=0.0.0-PR
      - name: Upload Maven local artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maven-local-linux
          path: ~/.m2/repository/com/ditchoom
          retention-days: 1

  apple:
    name: "Apple Targets"
    runs-on: macos-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'
          cache: gradle
      - name: Cache Konan
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: konan-${{ runner.os }}-${{ hashFiles('gradle/libs.versions.toml') }}
          restore-keys: konan-${{ runner.os }}-
      - name: Run Apple tests
        run: ./gradlew macosX64Test macosArm64Test iosSimulatorArm64Test tvosSimulatorArm64Test watchosSimulatorArm64Test ktlintCheck
      - name: Validate publish artifacts build
        # Build all Apple publishable artifacts to MavenLocal with fixed version for artifact collection
        run: |
          ./gradlew -Pversion=0.0.0-PR \
            publishIosArm64PublicationToMavenLocal \
            publishIosSimulatorArm64PublicationToMavenLocal \
            publishIosX64PublicationToMavenLocal \
            publishMacosArm64PublicationToMavenLocal \
            publishMacosX64PublicationToMavenLocal \
            publishTvosArm64PublicationToMavenLocal \
            publishTvosSimulatorArm64PublicationToMavenLocal \
            publishTvosX64PublicationToMavenLocal \
            publishWatchosArm64PublicationToMavenLocal \
            publishWatchosSimulatorArm64PublicationToMavenLocal \
            publishWatchosX64PublicationToMavenLocal
      - name: Upload Maven local artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maven-local-apple
          path: ~/.m2/repository/com/ditchoom
          retention-days: 1
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: docs/package-lock.json
      - name: Build documentation
        run: |
          ./gradlew copyDokkaToDocusaurus
          cd docs && npm ci && npm run build

  validate-artifacts:
    name: "Validate Multi-Platform Artifacts"
    needs: [linux-x64, apple]
    runs-on: ubuntu-latest
    steps:
      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: maven-local-linux
          path: maven-repo
      - name: Download Apple artifacts
        uses: actions/download-artifact@v4
        with:
          name: maven-local-apple
          path: maven-repo
          merge-multiple: true
      - name: Validate all platform artifacts present
        run: |
          VERSION="0.0.0-PR"
          MAVEN_LOCAL=maven-repo
          MISSING=0

          check_artifact() {
            local name=$1
            local ext=$2
            local path="$MAVEN_LOCAL/$name/$VERSION/$name-$VERSION.$ext"
            if [ -f "$path" ]; then
              echo "✓ Found: $name ($ext)"
            else
              echo "✗ Missing: $name ($ext) - expected at $path"
              MISSING=$((MISSING + 1))
            fi
          }

          echo "=== Validating Multi-Platform Artifacts ==="
          echo ""

          echo "--- KotlinMultiplatform Metadata ---"
          check_artifact "socket" "module"

          echo ""
          echo "--- JVM / JS / Android ---"
          check_artifact "socket-jvm" "jar"
          check_artifact "socket-js" "klib"
          check_artifact "socket-android" "aar"

          echo ""
          echo "--- Linux ---"
          check_artifact "socket-linuxx64" "klib"
          check_artifact "socket-linuxarm64" "klib"

          echo ""
          echo "--- iOS ---"
          check_artifact "socket-iosarm64" "klib"
          check_artifact "socket-iossimulatorarm64" "klib"
          check_artifact "socket-iosx64" "klib"

          echo ""
          echo "--- macOS ---"
          check_artifact "socket-macosarm64" "klib"
          check_artifact "socket-macosx64" "klib"

          echo ""
          echo "--- tvOS ---"
          check_artifact "socket-tvosarm64" "klib"
          check_artifact "socket-tvossimulatorarm64" "klib"
          check_artifact "socket-tvosx64" "klib"

          echo ""
          echo "--- watchOS ---"
          check_artifact "socket-watchosarm64" "klib"
          check_artifact "socket-watchossimulatorarm64" "klib"
          check_artifact "socket-watchosx64" "klib"

          echo ""
          echo "=== Summary ==="
          if [ $MISSING -eq 0 ]; then
            echo "All platform artifacts validated successfully!"
          else
            echo "ERROR: $MISSING artifact(s) missing!"
            exit 1
          fi
