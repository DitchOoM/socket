name: "Validate Merged Artifacts"

on:
  workflow_call:
    inputs:
      version:
        description: "Version string to validate"
        required: true
        type: string

jobs:
  validate:
    name: "Validate Artifacts"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: maven-local-linux
          path: /tmp/linux-repo/com/ditchoom

      - name: Download Apple artifacts
        uses: actions/download-artifact@v4
        with:
          name: maven-local-apple
          path: /tmp/apple-repo/com/ditchoom

      - name: Merge artifacts and module metadata
        run: |
          version="${{ inputs.version }}"
          LINUX_BASE="/tmp/linux-repo/com/ditchoom"
          APPLE_BASE="/tmp/apple-repo/com/ditchoom"
          MERGED="/tmp/maven-local/com/ditchoom"

          # Start with Linux artifacts
          mkdir -p /tmp/maven-local/com
          cp -r "$LINUX_BASE" /tmp/maven-local/com/

          # Copy Apple per-target artifacts
          for dir in "$APPLE_BASE"/socket-*/; do
            target_name=$(basename "$dir")
            cp -r "$dir" "$MERGED/$target_name"
          done

          # Merge root module metadata
          LINUX_MODULE="$LINUX_BASE/socket/$version/socket-$version.module"
          APPLE_MODULE="$APPLE_BASE/socket/$version/socket-$version.module"
          MERGED_MODULE="$MERGED/socket/$version/socket-$version.module"

          if [ -f "$LINUX_MODULE" ] && [ -f "$APPLE_MODULE" ]; then
            jq -s '
              .[0].variants = (
                [.[0].variants[], .[1].variants[]]
                | group_by(.name)
                | map(.[0])
              )
              | .[0]
            ' "$LINUX_MODULE" "$APPLE_MODULE" > "${MERGED_MODULE}.tmp"
            mv "${MERGED_MODULE}.tmp" "$MERGED_MODULE"
            echo "Merged module metadata: $(jq '.variants | length' "$MERGED_MODULE") variants"
          fi

      - name: Upload merged artifacts
        uses: actions/upload-artifact@v4
        with:
          name: maven-local-merged
          path: /tmp/maven-local
          retention-days: 1

      - name: Checkout validation project
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .ci/validate-resolution
            gradle/libs.versions.toml
          sparse-checkout-cone-mode: false

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Validate with Gradle resolution
        run: |
          gradle -p .ci/validate-resolution resolveAll \
            -PsocketVersion=${{ inputs.version }} \
            -PmavenRepoPath=/tmp/maven-local \
            --no-daemon

      - name: Validate Android AAR present
        run: |
          version="${{ inputs.version }}"
          AAR="/tmp/maven-local/com/ditchoom/socket-android/${version}/socket-android-${version}.aar"
          if [ ! -f "$AAR" ]; then
            echo "FAIL: Android AAR not found at ${AAR}"
            exit 1
          fi
          echo "Android AAR present"
