name: "Release"

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.2.3 without v prefix)'
        required: true
        type: string
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - complete
          - cancel

permissions:
  contents: write

jobs:
  complete-release:
    if: ${{ inputs.action == 'complete' }}
    runs-on: macos-latest
    env:
      ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.SONATYPE_NEXUS_USERNAME }}
      ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.SONATYPE_NEXUS_PASSWORD }}
      ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_SECRET }}
      ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_SIGNING_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'
          cache: gradle
      - name: Konan cache
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: konan-${{ runner.os }}-${{ hashFiles('**/*.gradle*', 'gradle/libs.versions.toml') }}
          restore-keys: |
            konan-${{ runner.os }}-
      - name: Gradle cache
        uses: gradle/actions/setup-gradle@v4
      - name: Release from staging
        run: ./gradlew releaseToMavenCentral
      - name: Create and push tag
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag -a "v${{ inputs.version }}" -m "Release v${{ inputs.version }}"
          git push origin "v${{ inputs.version }}"
      - name: Publish GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if a draft release exists
          DRAFT_EXISTS=$(gh release view "v${{ inputs.version }}" --repo="$GITHUB_REPOSITORY" --json isDraft -q '.isDraft' 2>/dev/null || echo "not_found")
          if [ "$DRAFT_EXISTS" = "true" ]; then
            # Update draft to published
            gh release edit "v${{ inputs.version }}" \
              --repo="$GITHUB_REPOSITORY" \
              --draft=false \
              --notes "## Maven Central

          \`\`\`kotlin
          implementation(\"com.ditchoom:socket:${{ inputs.version }}\")
          \`\`\`

          [View on Maven Central](https://central.sonatype.com/artifact/com.ditchoom/socket/${{ inputs.version }})"
          else
            # Create new release
            gh release create "v${{ inputs.version }}" \
              --repo="$GITHUB_REPOSITORY" \
              --title="socket ${{ inputs.version }}" \
              --generate-notes \
              --notes "## Maven Central

          \`\`\`kotlin
          implementation(\"com.ditchoom:socket:${{ inputs.version }}\")
          \`\`\`

          [View on Maven Central](https://central.sonatype.com/artifact/com.ditchoom/socket/${{ inputs.version }})"
          fi

  cancel-release:
    if: ${{ inputs.action == 'cancel' }}
    runs-on: ubuntu-latest
    steps:
      - name: Check for draft release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE=$(gh release view "v${{ inputs.version }}" --repo="$GITHUB_REPOSITORY" --json isDraft -q '.isDraft' 2>/dev/null || echo "not_found")
          if [ "$RELEASE" = "not_found" ]; then
            echo "Release v${{ inputs.version }} not found"
            exit 0
          elif [ "$RELEASE" = "true" ]; then
            echo "Deleting draft release v${{ inputs.version }}"
            gh release delete "v${{ inputs.version }}" --repo="$GITHUB_REPOSITORY" --yes
          else
            echo "Release v${{ inputs.version }} is already published. Cannot cancel."
            exit 1
          fi
      - name: Reminder
        run: |
          echo "::warning::Remember to manually drop the staging repository in Maven Central if it was created."
